<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
        integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js"
        integrity="sha512-KZmyTq3PLx9EZl0RHShHQuXtrvdJ+m35tuOiwlcZfs/rE7NZv29ygNA8SFCkMXTnYZQK2OX0Gm2qKGfvWEtRXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"
        integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 1500,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        })

    </script>
</head>

<body ng-app="myApp">
    <div class="container" ng-controller="profileController">
        <div class="row mt-2">
            <div class="col-2">
                <label for="name">Họ tên: </label>
            </div>
            <div class="col-10">
                <input type="text" name="" id="name" class="form-control" autocomplete="off"
                    ng-model="curentUser.fullname">
                <small class="text-danger" id="fullnameId"></small>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-2">
                <label for="email">Email: </label>
            </div>
            <div class="col-10">
                <input type="email" name="" id="email" class="form-control" autocomplete="off"
                    ng-model="curentUser.email">
                <small class="text-danger" id="emailId"></small>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-2">
                <label for="sdt">Điện thoại: </label>
            </div>
            <div class="col-10">
                <input type="text" name="" id="sdt" class="form-control" autocomplete="off"
                    ng-model="curentUser.phoneNumber">
                <small class="text-danger" id="phoneNumberId"></small>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-2">
                <label for="address">Địa chỉ: </label>
            </div>
            <div class="col-10">
                <input type="text" name="" id="address" class="form-control" autocomplete="off"
                    ng-model="curentUser.address">
                <small class="text-danger" id="addressId"></small>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-2">
                <label for="imgae">Ảnh: </label>
            </div>
            <div class="col-10">
                <input type="file" name="" id="imgae" class="form-control" accept=".jpg,.png,.jpeg"
                    file-model="curentUser.image">
            </div>
        </div>
        <div class="col-4 mt-3">
            <button class="btn btn-secondary" ng-click="reset()">Đặt lại</button>
            <button class="btn btn-primary" ng-click="check()">Thay đổi</button>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="saveModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Xác nhận thông tin</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Bạn chắc chắn muốn thay đổi thông tin?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" ng-click="save()">Chắc
                            chắn</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const app = angular.module("myApp", []);
        //khi ghép code xóa này đi. giả lập tag
        app.directive('fileModel', ['$parse', function ($parse) {
            return {
                restrict: 'A',
                link: function (scope, element, attrs) {
                    var model = $parse(attrs.fileModel);
                    var modelSetter = model.assign;

                    element.bind('change', function () {
                        scope.$apply(function () {
                            modelSetter(scope, element[0].files[0]);
                        });
                    });
                }
            };

        }]);
        //
        app.controller("profileController", function ($scope, $http, $rootScope) {
            //gỉa lập đăng nhập khi ghép nhớ xóa
            $http.get("/api/admin/pricipal").then(function (response) {
                $rootScope.authen = response.data;
                $scope.curentUser = angular.copy($rootScope.authen);
            })
            //
            $scope.init = function () {
                $("#fullnameId").val("")
                $("#emailId").val("")
                $("#phoneNumberId").val("")
                $("#adressId").val("")
            }
            $scope.curentUser = angular.copy($rootScope.authen);
            $scope.reset = function () {
                $scope.curentUser = angular.copy($rootScope.authen);
                $("#imgae").val('')
            }
            $scope.save = function () {
                let myForm = new FormData();
                var config = {
                    "transformRequest": angular.identity,
                    "transformResponse": angular.identity,
                    "headers": {
                        'Content-Type': undefined
                    }
                }
                myForm.append("fullname", $scope.curentUser.fullname)
                myForm.append("email", $scope.curentUser.email)
                myForm.append("phoneNumber", $scope.curentUser.phoneNumber)
                myForm.append("address", $scope.curentUser.address)
                if($("#imgae").val()!=""){
                    myForm.append("file", $scope.curentUser.image)
                }
                $http.put("/api/admin/profile", myForm, config).then(function (response) {
                    console.log(response.data)
                    if (response.data == 0) {
                        Toast.fire({
                            icon: 'success',
                            title: "Đổi thông tin thành công"
                        })
                    } else if (response.data == 1) {
                        Toast.fire({
                            icon: 'error',
                            title: "Lỗi thông tin"
                        })
                    } else if (response.data == 2) {
                        Toast.fire({
                            icon: 'error',
                            title: "Email trùng lặp"
                        })
                    } else {
                        Toast.fire({
                            icon: 'error',
                            title: "Máy chủ bận"
                        })
                    }
                })
            }
            $scope.check = function () {
                $http.put("/api/admin/profile/before", $scope.curentUser).then(function (response) {
                    if (response.data.statusCode == "ok") {
                        $("#saveModal").modal("show");
                    } else {
                        let data = response.data.data; console.log(response.data.data)
                        for (let i = 0; i < data.length; i++) {
                            document.getElementById(data[i].field + "Id").innerText = data[i].defaultMessage;
                        }
                    }
                })
            }
        })
    </script>
</body>

</html>